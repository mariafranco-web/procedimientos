CREATE PROCEDURE `amrl-data-prd`.OPERATIONAL.SP_OBT_PIVOT_FACT_ESTADO_DE_CUENTA()
OPTIONS(
  description="\nPropósito: Crear y actualizar la tabla OBT_PIVOT_ESTADO_DE_CUENTA en el DataSet de CONSUMPTION, La tabla contienes toda la informacion de la OBT_FACT_ESTADO_DE_CUENTA con la diferencia de que la cantidad de conceptos asociados a una oportunidad se muestran en columnas y no en filas como en la OBT_FACT_ESTADO_DE_CUENTA. \nAutor: Maria Fernanda Franco\nUsos: Tracking Tools\nFecha de Creacion: 2025-01-15 10:36 AM \nModificaciones: \n20-05-2025: Se ajusta la consulta de la variable contador con el objetivo de identificar la oportunidad con mayor cantidad de artículos asociados(OP585373,585371, 585373 con 21 articulos)\n09-09-2025: Se incluyen las columnas FECHA_ULTIMO_PAGO_REALIZADO y MONTO_ULTIMO_PAGO_REALIZADO")
BEGIN

DECLARE Consulta STRING;

--Incluye los datos de FROM y GROUP BY 
SET Consulta = "SELECT T_1.BK_NUMERO_OP, MAX(CASE WHEN tipo_concepto = 'CREDITO' THEN T_1.CONCEPTO END) AS CONCEPTO_CREDITO, MAX(CASE WHEN tipo_concepto = 'CREDITO' THEN ENTIDAD_FINANCIERA END) AS ENTIDAD_CREDITO, MAX(CASE WHEN tipo_concepto = 'CREDITO' THEN VALOR_PACTADO END) AS VALOR_CREDITO, MAX(CASE WHEN tipo_concepto = 'CREDITO_TERCERO_1' THEN T_1.CONCEPTO END) AS CONCEPTO_CREDITO_TERCERO_1, MAX(CASE WHEN tipo_concepto = 'CREDITO_TERCERO_1' THEN ENTIDAD_FINANCIERA END) AS ENTIDAD_CREDITO_TERCERO_1, MAX(CASE WHEN tipo_concepto = 'CREDITO_TERCERO_1' THEN VALOR_PACTADO END) AS VALOR_CREDITO_TERCERO_1, MAX(CASE WHEN tipo_concepto = 'CREDITO_TERCERO_2' THEN T_1.CONCEPTO END) AS CONCEPTO_CREDITO_TERCERO_2, MAX(CASE WHEN tipo_concepto = 'CREDITO_TERCERO_2' THEN ENTIDAD_FINANCIERA END) AS ENTIDAD_CREDITO_TERCERO_2, MAX(CASE WHEN tipo_concepto = 'CREDITO_TERCERO_2' THEN VALOR_PACTADO END) AS VALOR_CREDITO_TERCERO_2, MAX(CASE WHEN tipo_concepto = 'SUBSIDIO_1' THEN T_1.CONCEPTO END) AS CONCEPTO_SUBSIDIO_1, MAX(CASE WHEN tipo_concepto = 'SUBSIDIO_1' THEN ENTIDAD_FINANCIERA END) AS ENTIDAD_SUBSIDIO_1, MAX(CASE WHEN tipo_concepto = 'SUBSIDIO_1' THEN VALOR_PACTADO END) AS VALOR_SUBSIDIO_1, MAX(CASE WHEN tipo_concepto = 'SUBSIDIO_2' THEN T_1.CONCEPTO END) AS CONCEPTO_SUBSIDIO_2, MAX(CASE WHEN tipo_concepto = 'SUBSIDIO_2' THEN ENTIDAD_FINANCIERA END) AS ENTIDAD_SUBSIDIO_2, MAX(CASE WHEN tipo_concepto = 'SUBSIDIO_2' THEN VALOR_PACTADO END) AS VALOR_SUBSIDIO_2, MAX(CASE WHEN tipo_concepto = 'SEPARACION' THEN VALOR_PACTADO END) AS VALOR_SEPARACION, MAX(CASE WHEN tipo_concepto = 'CUOTA 1' THEN VALOR_PACTADO END) AS CUOTA_1, T_2.FECHA_ULTIMO_PAGO_REALIZADO, T_2.MONTO_ULTIMO_PAGO_REALIZADO FROM(SELECT BK_NUMERO_OP, CONCEPTO, ENTIDAD_FINANCIERA, VALOR_PACTADO, CASE WHEN CONCEPTO LIKE '%CREDITO TERCERO 1%' THEN 'CREDITO_TERCERO_1' WHEN CONCEPTO LIKE '%CREDITO TERCERO 2%' THEN 'CREDITO_TERCERO_2' WHEN CONCEPTO LIKE '%CREDITO TERCERO_ESC 1%' THEN 'CREDITO_TERCERO_ESC_1' WHEN CONCEPTO LIKE '%CREDITO TERCERO_ESC 2%' THEN 'CREDITO_TERCERO_ESC_2' WHEN CONCEPTO LIKE '%CREDITO_ESC%' THEN 'CREDITO_ESC' WHEN CONCEPTO LIKE '%SUBSIDIO 1%' THEN 'SUBSIDIO_1' WHEN CONCEPTO LIKE '%SUBSIDIO 2%' THEN 'SUBSIDIO_2' WHEN CONCEPTO LIKE '%SUBSIDIO_ESC 1%' THEN 'SUBSIDIO_ESC_1' WHEN CONCEPTO LIKE '%SUBSIDIO_ESC 2%' THEN 'SUBSIDIO_ESC_2' WHEN CONCEPTO LIKE 'CREDITO%' THEN 'CREDITO' WHEN CONCEPTO LIKE 'SEPARACION%' THEN 'SEPARACION' WHEN CONCEPTO LIKE 'CUOTA 1%' THEN 'CUOTA 1' ELSE 'OTRO' END AS tipo_concepto FROM `CONSUMPTION.OBT_FACT_ESTADO_CUENTA` WHERE CONCEPTO LIKE '%SUBSIDIO%' OR CONCEPTO LIKE '%CREDITO%' OR CONCEPTO LIKE '%SEPARACION%' OR CONCEPTO ='CUOTA 1') AS T_1 LEFT JOIN (SELECT * FROM (SELECT A.BK_NUMERO_OP, A.CONCEPTO, A.VALOR_EN_MORA, B.FECHA_DE_COBRO AS FECHA_ULTIMO_PAGO_REALIZADO, B.IMPORTE_APLICADO AS MONTO_ULTIMO_PAGO_REALIZADO, ROW_NUMBER() OVER (PARTITION BY A.BK_NUMERO_OP ORDER BY B.FECHA_DE_COBRO DESC) AS row_num FROM `PRESENTATION.FACT_ESTADO_CUENTA` AS A LEFT JOIN `PRESENTATION.DIM_COBRO` AS B ON A.BK_COBRO = B.SK_COBRO WHERE SK_COBRO IS NOT NULL) AS T_0 WHERE row_num = 1) AS T_2 ON T_1.BK_NUMERO_OP = T_2.BK_NUMERO_OP GROUP BY T_1.BK_NUMERO_OP, T_2.FECHA_ULTIMO_PAGO_REALIZADO, T_2.MONTO_ULTIMO_PAGO_REALIZADO";


--Imprime la consulta construida
SELECT Consulta;

--Ejecuta la consulta y la inserta en la tabla `CONSUMPTION.PIVOT_OBT_ESTADO_DE_CUENTA` ' ||
EXECUTE IMMEDIATE 
 'CREATE OR REPLACE TABLE `CONSUMPTION.PIVOT_OBT_ESTADO_DE_CUENTA`' ||
 'AS ' || Consulta;


END;